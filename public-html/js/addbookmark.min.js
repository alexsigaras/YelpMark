var tagConflictText="Tag already exists!",modifyConflictText="Please change the conflicted tag name!",blankText="Type any text to make tag",addBookmarkBtnClick=function(a,t,n){"string"==typeof a&&(a=JSON.parse(a));var e=bookmark.getItem("tags");$(".addTag .addInformation .tagSelector").empty(),$(".addTag .addInformation .tag").remove(),$(".addComment textarea").val(""),$(".conflictWarning").remove(),$(".addTag .tag").remove(),$("#newTagInput").val(""),n?$("#addBookmarkModal h2").text("Edit Bookmark"):$("#addBookmarkModal h2").text("Add Bookmark");var o=$(".addTag .addInformation select.tagSelector").append("<option value='default'>Select from existing tag</option>");if(e&&e.length>0){for(var i=0;i<e.length;i++)o.append("<option value='"+e[i]+"'>"+e[i]+"</option>");o.unbind("change"),o.change(function(){if("default"!=$(this).val()){var a=$(this).val(),t=$("<input class='tag existing' value='"+a+"' readonly>").click(function(){$(this).remove(),o.append("<option value='"+a+"'>"+a+"</option>"),$('.addTag .addInformation .tagSelector option[value="default"]').text("Select from existing tag")});$(".addTag .addInformation .currentTags").after(t),$('.addTag .addInformation .tagSelector option[value="'+$(this).val()+'"]').remove(),$(this).val("default"),1==$(".addTag .addInformation .tagSelector option").length&&$('.addTag .addInformation .tagSelector option[value="default"]').text("No tag anymore")}})}else $('.addTag .addInformation .tagSelector option[value="default"]').text("No tag anymore");var l=$("#newTagInput");bindConflictWarningEvent(l,e),$("#addTagBtn").unbind("click");$("#addTagBtn").click(function(){if($(".conflictWarning").length&&""!=l.val())$(".conflictWarning").text(modifyConflictText),setTimeout(function(){$(".conflictWarning").text(tagConflictText)},2e3);else if(""==l.val())$(".conflictWarning").length?$(".conflictWarning").text(blankText):$('<div class="conflictWarning" style="display:none">'+blankText+"</div>").insertBefore($(".addComment")).fadeIn(),setTimeout(function(){$(".conflictWarning").remove()},2e3);else{var a=$("<input class='tag'/>").click(function(){$(this).remove()});a.val($("#newTagInput").val()),$(".candidateTags").append(a),$("#newTagInput").val("")}});if($("#addBookmarkModal").modal("show"),!t&&n&&a){for(var i=0;i<a.tags.length;i++)o.val(a.tags[i]).trigger("change");$(".addComment textarea").val(a.comment)}$("#addBookmarkModal .okay").unbind("click"),$("#addBookmarkModal .okay").click(function(){if($(".conflictWarning").length)return alert("Please modify the conflict tag"),!1;var e="";$(".tag").each(function(){e+="|"+$(this).val()});var o=$(".addComment textarea").val();t?callAddBookmark(a,e,o,t):n&&confirm("Do you want to edit it? Modified bookmark will be displayed at last element")&&(bookmark.deleteItem(a.id),callAddBookmark(JSON.parse(a.obj),e,o,t))}),$("#addBookmarkModal .close").click(function(){return!0})},checkTagValidation=function(a,t){var n=!0,e=$(".addTag .tag").length,o=0;if($(".addTag .tag").each(function(){o<e&&$(this).val()==a.val()&&""!=a.val()&&(n=!1),o+=1}),!n)return n;if(t)for(var e=0;e<t.length;e++)if(a.val()==t[e])return!1;return!0},bindConflictWarningEvent=function(a,t){a.keyup(function(a){13==a.keyCode||""!=$(this).val()&&(checkTagValidation($(this),t)?$(this).hasClass("conflict")&&($(".conflictWarning").remove(),$(this).removeClass("conflict")):($(".conflictWarning").length||$('<div class="conflictWarning" style="display:none">'+tagConflictText+"</div>").insertBefore($(".addComment")).fadeIn(),$(this).addClass("conflict")))})};